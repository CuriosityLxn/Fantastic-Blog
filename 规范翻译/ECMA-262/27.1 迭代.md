### 27.1.1 常见的迭代协议

协议是属性键的一组集合，其关联的属性值匹配特定的规范。任何提供协议规范所描述的所有属性的对象都符合该协议。协议不是一个指定的对象。可能有很多单独实现的对象遵从任意协议。一个单独的对象可能遵从多个协议。

##### 27.1.1.1 可迭代协议

表 66 中是可迭代协议包含的属性：

*表 66 可迭代协议所需属性*

| 属性 | 值 | 要求 |
| --- | --- | --- |
| @@iterator | 返回迭代器对象的函数。 | 返回的对象必须遵守迭代器协议。 |

##### 27.1.1.2 迭代器协议

实现迭代器协议的对象必须表 67 和表 68 中的属性。

*表 67 迭代器协议必需属性*

| 属性 | 值 | 要求 |
| --- | --- | --- |
| "next" | 函数，返回迭代器结果对象。 | 返回的对象必须遵守迭代器结果协议。如果对前一个迭代器调用了 **next** 方法，返回一个 **done** 为 **true** 的迭代器结果对象，那么后续所有对这个对象的 **next** 方法调用都返回一个 **done** 为 **true** 的迭代器结果对象。然而，不会强制执行这一要求。 |

> 注意⚠️：1. **next** 函数可以接受传参，参数的解析和有效性取决于目标迭代器。**for-of** 循环和迭代器的其他常见用法不传递任何实参，所以希望以这种方式使用的迭代器对象必须准备好处理没有实参的调用。

![img3.png](https://i.postimg.cc/9FKc2Vwf/585-AC5-C6-78-FB-4-E33-8-A57-4-BB429683274.png)


![img2.png](https://i.postimg.cc/hGqgJrrW/CEDB5-D94-59-CE-473-A-AAA2-AE3-DC099-EB69.png)

*表 68 迭代器协议操作属性*

| 属性 | 值 | 共有要求 | 要求区别 ｜
| --- | --- | --- | --- |
| "return" | 函数，返回迭代器结果对象。 | 返回的对象必须遵守迭代器结果协议。 | 调用此方法将通知迭代器对象，调用者迭代不会再调用 **next** 方法。返回的迭代器结果对象依然有一个值为 **true** 的 **done** 属性和一个 **value** 属性，**value** 的值为传给 **return** 方法的实参。该要求不会被强制执行。 |
| "throw" | 函数，返回迭代器结果对象。 | 返回的对象必须遵守迭代器结果协议。 | 调用此方法将通知迭代器对象，调用者发现了一个错误条件。参数通常是一个异常对象，用于标识错误条件。典型响应是抛出实参的值。若迭代器不进行 **throw** 操作，则返回的迭代器结果对象的 **done** 属性为 **true**。 |

> 注意⚠️：2. 通常这些方法的调用者应该在引用这些方法之前先，先检查方法是否存在。包括 **for-of**，**yield*** 及数组结构在内的某些特性，在执行存在性检测之后才会调用这些方法。大多数接受迭代器对象作为传参 ES 库函数也会有条件的调用它们。

##### 27.1.1.3 异步可迭代协议

实现迭代器协议的对象必须表 69 中的属性。

*表 69 异步可迭代协议的必需属性*


| 属性 | 值 | 要求 |
| --- | --- | --- |
| @@asyncIterator | 函数，返回一个异步迭代器对象。 |  返回的对象必须遵守异步迭代器协议。|

##### 27.1.1.4 异步迭代器协议

符合异步迭代器协议的实例对象必须包含表 70 中的属性，和表 71 中的操作属性。

*表 70 异步迭代器协议必需属性*

| 属性 | 值 | 要求 |
| --- | --- | --- |
| "next" | 函数，返回一个作为 Promise 的迭代器结果对象。 | 当返回的 Promise 对象为 fulfilled 时，必须使用一个遵从迭代器结果协议的对象来实现。如果先前对异步迭代器协议 **next** 方法的调用，已经返回了 **done** 属性为 **true** 的 Promise 迭代器结果对象，后续对其进行的所有**next** 方法调用都将返回**done** 属性为 **true** 的 Promise 迭代器结果对象。这一要求没有被强制执行。另外，迭代器结果对象的作为 Promise 完成状态的值，需要有一个 **value** 属性，value 的值不能是 Promise 类型（或 "thenable"）的。同样这条要求也没有被强制执行。 |

> 注意⚠️：1. **next** 函数可以接受传参，参数的解析和有效性取决于目标异步迭代器。for-await-of 循环和异步迭代器的其他常见用法不传递任何实参，所以希望以这种方式使用的迭代器对象必须准备好处理没有实参的调用。

*表 71 异步迭代器协议操作属性*


| 属性 | 值 | 要求 |
| --- | --- | --- |
| "return" | 同 "next" | 结合表 68 和表 70 可得。补充：**return** 方法可以接受传参，若参数是以典型方式传进来时，1. 当参数是一个被拒绝的 promise，需要返回一个相同原因的 promise 拒绝；2. 当参数是一个完成了的 promise，那么它的完成值应该用作返回的 Promise 的迭代器结果对象的完成值的 **value** 属性。该要求没有被强制执行。 |
| "throw" | 同 "next" | 结合表 68 和表 70 可得。补充：典型的响应是返回一个**被拒绝的 promise**，这个 **Promise** 的拒绝是传参的值。 |

注意⚠️：2. 通常这些方法的调用者应该在引用这些方法之前先，先检查方法是否存在。包括 **for-await-of**，**yield*** 在内的某些特性，在执行存在性检测之后才会调用这些方法。大多数接受迭代器对象作为传参 ES 库函数也会有条件的调用它们。

##### 27.1.1.5 迭代器结果协议

迭代器结果协议需要包含表 72 中的属性：

*表 72 迭代器结果协议属性*


| 属性 | 值 | 要求 |
| --- | --- | --- |
| "done" | **true** 或 **false** | 这是迭代器 **next** 方法调用的结果状态。如果到达迭代器的末尾则 **done** 为 **true**，否则 **done** 为 **false** 且有可用的 **value**。如果 **done** 属性（不管是自有的还是继承来的）不存在，会被当作 **done** 为 **false**。 |
| "value" | 任意类型 | 若 **done** 为 **false**， **value** 就是当前迭代元素的返回值。若 **done** 为 **true**，且有 **value**，那么 **value** 就是迭代器的值。若迭代器没有返回值，则 **value** 为 **undefined**。在这种情况下，如果遵守协议的对象没有继承显式的 **"value"** 值，则 **"value"** 属性可能是不存在的。 |

![img2.png](https://i.postimg.cc/JzXM4gj5/4710693-B-6-D55-431-E-895-F-2-D37-E2-A3-EC5-D.png)

### 27.1.2 迭代器原型对象 IteratorPrototype

- 内部插槽 [[Prototype]] 的值是 [Object.prototype](https://tc39.es/ecma262/#sec-properties-of-the-object-prototype-object)。
- 是一个[一般对象](https://tc39.es/ecma262/#ordinary-object)。

> 在本规范中定义的迭代器协议的所有实例对象也继承自 **迭代器原型对象**。代码中也可以定义继承自迭代器原型对象的对象。迭代器原型对象提供了一片地方，可以添加用于所有迭代器对象的额外方法。
> 
> 下面的例子是获取迭代器原型对象的一种方式：
> 
> `Object.getPrototypeOf(Object.getPrototypeOf([][Symbol.iterator]()))`

##### 27.1.2.1 迭代器原型对象的 iterator 函数

IteratorPrototype [ @@iterator ] ( )

下面的步骤会被执行：

1. 返回 **this** 的值。

这个函数的属性名是 **"[Symbol.iterator]"**。

### 27.1.3 异步迭代器的原型对象 AsyncIteratorPrototype

同 27.1.2 迭代器原型对象，Note 可类比。

##### 27.1.3.1 异步迭代器原型对象的 iterator 函数
%AsyncIteratorPrototype% [ @@asyncIterator ] ( )

下面的步骤会被执行：

1. 返回 **this** 的值。

这个函数的属性名是 **"[Symbol.asyncIterator]"**。


### 14.7.5 for-in，for-of，for-await-of 语句

##### 14.7.5.10 for-in 迭代器对象

for-in 迭代器对象会对某些特定对象进行特定迭代。for-in 迭代器对象不会直接访问代码；它们的存在只是为了说明 [EnumerateObjectProperties](https://tc39.es/ecma262/#sec-enumerate-object-properties) (可列举的对象属性)的行为。

 
